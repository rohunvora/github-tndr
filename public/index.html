<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Project Portfolio</title>
  <style>
    :root {
      /* Light Mode Colors - matching reference (Tailwind palette) */
      --green-text: #22C55E;
      --green-bg: #DCFCE7;
      --green-face: #22C55E;
      --blue-text: #3B82F6;
      --blue-bg: #DBEAFE;
      --blue-face: #3B82F6;
      --red-text: #EF4444;
      --red-bg: #FEE2E2;
      --red-face: #EF4444;
      
      /* Neutral colors */
      --bg: #FFFFFF;
      --bg-secondary: #F7F7F8;
      --bg-tertiary: #F0F0F2;
      --text: #1A1A1A;
      --text-secondary: #525252;
      --text-muted: #737373;
      --text-faint: #A3A3A3;
      --border: #E5E5E5;
      --card-bg: #FFFFFF;
      --count-bg: rgba(255,255,255,0.8);
      
      /* Typography */
      --font-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      --text-base: 15px;
      --text-sm: 13px;
      --text-xs: 11px;
      --text-lg: 17px;
      --text-xl: 20px;
      --text-2xl: 28px;
      --line-height: 1.6;
      --line-height-tight: 1.4;
      
      /* Spacing */
      --space-1: 4px;
      --space-2: 8px;
      --space-3: 12px;
      --space-4: 16px;
      --space-5: 20px;
      --space-6: 24px;
      --space-8: 32px;
      --space-10: 40px;
      
      /* Layout */
      --content-width: 720px;
      --radius: 12px;
      --radius-sm: 8px;
    }
    
    /* Dark Mode */
    [data-theme="dark"] {
      --green-text: #4ADE80;
      --green-bg: #14532D;
      --green-face: #22C55E;
      --blue-text: #60A5FA;
      --blue-bg: #1E3A5F;
      --blue-face: #3B82F6;
      --red-text: #F87171;
      --red-bg: #450A0A;
      --red-face: #EF4444;
      
      --bg: #141414;
      --bg-secondary: #1C1C1C;
      --bg-tertiary: #242424;
      --text: #E5E5E5;
      --text-secondary: #B3B3B3;
      --text-muted: #8C8C8C;
      --text-faint: #666666;
      --border: #2E2E2E;
      --card-bg: #1C1C1C;
      --count-bg: rgba(0,0,0,0.3);
    }
    
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: var(--font-sans);
      font-size: var(--text-base);
      line-height: var(--line-height);
      color: var(--text);
      background: var(--bg);
      margin: 0;
      padding: var(--space-10) var(--space-6);
      min-height: 100vh;
      transition: background 0.2s ease, color 0.2s ease;
    }
    
    .container {
      max-width: var(--content-width);
      margin: 0 auto;
    }
    
    /* Header */
    .header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: var(--space-2);
    }
    
    h1 {
      font-size: var(--text-2xl);
      font-weight: 600;
      line-height: var(--line-height-tight);
      margin: 0;
      letter-spacing: -0.02em;
    }
    
    /* Theme toggle */
    .theme-toggle {
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: var(--space-2) var(--space-3);
      cursor: pointer;
      font-family: var(--font-sans);
      font-size: var(--text-sm);
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: var(--space-2);
      transition: all 0.15s ease;
    }
    .theme-toggle:hover {
      background: var(--bg-secondary);
      color: var(--text-secondary);
    }
    .theme-toggle svg {
      width: 16px;
      height: 16px;
    }
    
    .subtitle {
      font-size: var(--text-base);
      color: var(--text-muted);
      margin: 0 0 var(--space-6) 0;
    }
    
    .stats {
      font-size: var(--text-sm);
      color: var(--text-muted);
      margin-bottom: var(--space-8);
    }
    .stats strong {
      color: var(--text-secondary);
    }

    /* Section containers */
    .section {
      margin-bottom: var(--space-6);
      border-radius: var(--radius);
      overflow: hidden;
      transition: background 0.2s ease;
    }
    .section.green { background: var(--green-bg); }
    .section.blue { background: var(--blue-bg); }
    .section.red { background: var(--red-bg); }

    /* Section headers */
    .section-header {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-4) var(--space-5);
    }
    
    /* Pixel faces */
    .pixel-face {
      width: 36px;
      height: 36px;
      flex-shrink: 0;
      image-rendering: pixelated;
    }
    
    .section-title {
      flex: 1;
      min-width: 0;
    }
    .section-title h2 {
      margin: 0;
      font-size: var(--text-lg);
      font-weight: 600;
      color: var(--text);
      line-height: var(--line-height-tight);
    }
    .section-subtitle {
      font-size: var(--text-sm);
      margin-top: 2px;
      line-height: var(--line-height-tight);
    }
    .section.green .section-subtitle { color: var(--green-text); }
    .section.blue .section-subtitle { color: var(--blue-text); }
    .section.red .section-subtitle { color: var(--red-text); }
    
    .section-count {
      font-size: var(--text-sm);
      font-weight: 600;
      padding: var(--space-1) var(--space-3);
      border-radius: 100px;
      background: var(--count-bg);
      flex-shrink: 0;
    }
    .section.green .section-count { color: var(--green-text); }
    .section.blue .section-count { color: var(--blue-text); }
    .section.red .section-count { color: var(--red-text); }

    /* Table styling */
    .section-content {
      background: var(--card-bg);
      border-radius: 0 0 var(--radius) var(--radius);
      transition: background 0.2s ease;
    }
    
    table { 
      width: 100%; 
      border-collapse: collapse;
    }
    
    th, td { 
      text-align: left; 
      padding: var(--space-3) var(--space-4);
      border-bottom: 1px solid var(--border);
      vertical-align: top;
    }
    th { 
      background: var(--bg-secondary);
      font-size: var(--text-xs);
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
    }
    tr:last-child td {
      border-bottom: none;
    }
    
    /* Project cell */
    .project-name {
      font-size: var(--text-base);
      font-weight: 500;
      color: var(--text);
      text-decoration: none;
    }
    a.project-name:hover {
      text-decoration: underline;
    }
    .project-stars {
      color: var(--text-faint);
      font-size: var(--text-sm);
      margin-left: var(--space-2);
    }
    .verdict { 
      font-size: var(--text-sm);
      color: var(--text-muted);
      margin-top: var(--space-1);
      line-height: var(--line-height);
    }
    
    /* Description cell */
    .desc {
      font-size: var(--text-sm);
      color: var(--text-secondary);
      line-height: var(--line-height);
    }

    /* Live link buttons */
    .btn-live {
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
      padding: var(--space-2) var(--space-3);
      border-radius: var(--radius-sm);
      font-size: var(--text-sm);
      font-weight: 500;
      text-decoration: none;
      transition: opacity 0.15s ease;
      white-space: nowrap;
    }
    .btn-live:hover {
      opacity: 0.85;
    }
    .section.green .btn-live {
      background: var(--green-text);
      color: white;
    }
    .section.blue .btn-live {
      background: var(--blue-text);
      color: white;
    }
    .section.red .btn-live {
      background: var(--red-text);
      color: white;
    }
    [data-theme="dark"] .btn-live {
      color: var(--bg);
    }
    .no-link {
      color: var(--text-faint);
      font-size: var(--text-sm);
    }

    /* Sortable column header */
    th.sortable {
      cursor: pointer;
      user-select: none;
    }
    th.sortable:hover {
      color: var(--text-secondary);
    }
    th.sortable::after {
      content: ' ↕';
      opacity: 0.3;
    }
    th.sortable.asc::after {
      content: ' ↑';
      opacity: 1;
    }
    th.sortable.desc::after {
      content: ' ↓';
      opacity: 1;
    }

    /* Last commit column */
    .last-commit {
      font-size: var(--text-sm);
      color: var(--text-muted);
      white-space: nowrap;
    }
    .last-commit.recent {
      color: var(--green-text);
    }
    .last-commit.stale {
      color: var(--text-faint);
    }

    /* Collapsible */
    .section-toggle {
      display: none;
      width: 100%;
      padding: var(--space-3) var(--space-4);
      background: var(--card-bg);
      border: none;
      cursor: pointer;
      font-family: var(--font-sans);
      font-size: var(--text-sm);
      color: var(--text-muted);
      text-align: left;
      border-radius: 0 0 var(--radius) var(--radius);
      transition: background 0.15s ease;
    }
    .section-toggle:hover {
      background: var(--bg-secondary);
    }
    .section.collapsed .section-content {
      display: none;
    }
    .section.collapsed .section-toggle {
      display: block;
    }
    
    /* Responsive - tablet */
    @media (max-width: 768px) {
      body {
        padding: var(--space-6) var(--space-4);
      }
      
      h1 {
        font-size: var(--text-xl);
      }
      
      .section-header {
        padding: var(--space-3) var(--space-4);
      }
      
      .pixel-face {
        width: 32px;
        height: 32px;
      }
      
      .section-title h2 {
        font-size: var(--text-base);
      }
      
      th, td {
        padding: var(--space-3);
      }
      
      table, thead, tbody, th, td, tr {
        display: block;
      }
      thead {
        display: none;
      }
      tr {
        padding: var(--space-3) var(--space-4);
        border-bottom: 1px solid var(--border);
      }
      tr:last-child {
        border-bottom: none;
      }
      td {
        padding: 0;
        border: none;
      }
      td.desc {
        margin-top: var(--space-2);
      }
      td:last-child {
        margin-top: var(--space-3);
      }
    }
    
    /* Responsive - small mobile */
    @media (max-width: 480px) {
      body {
        padding: var(--space-4) var(--space-3);
      }
      
      .header {
        flex-direction: column;
        gap: var(--space-3);
      }
      
      .section-header {
        gap: var(--space-2);
        padding: var(--space-3);
      }
      
      .pixel-face {
        width: 28px;
        height: 28px;
      }
      
      .section-count {
        font-size: var(--text-xs);
        padding: 2px var(--space-2);
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Project Status</h1>
      <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme">
        <svg class="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="5"/>
          <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
        </svg>
        <span class="theme-label">Light</span>
      </button>
    </div>
    <p class="subtitle">What's active, what's done, what's paused.</p>

    <div class="stats">
      <strong>Summary:</strong>
      <span id="ship-count">0</span> active,
      <span id="cut-count">0</span> done,
      <span id="kill-count">0</span> paused
    </div>

    <!-- Ship Section -->
    <div class="section green" id="section-ship">
      <div class="section-header">
        <svg class="pixel-face" viewBox="0 0 16 16">
          <rect width="16" height="16" class="face-fill-green"/>
          <rect x="4" y="4" width="2" height="2" class="face-feature"/>
          <rect x="10" y="4" width="2" height="2" class="face-feature"/>
          <rect x="4" y="10" width="2" height="1" class="face-feature"/>
          <rect x="6" y="11" width="4" height="1" class="face-feature"/>
          <rect x="10" y="10" width="2" height="1" class="face-feature"/>
        </svg>
        <div class="section-title">
          <h2>Active</h2>
          <div class="section-subtitle">Currently working on these</div>
        </div>
        <span class="section-count" id="ship-badge">0</span>
      </div>
      <div class="section-content">
        <table id="table-ship">
          <thead>
            <tr>
              <th>Project</th>
              <th>Description</th>
              <th class="sortable" onclick="sortTable('ship', 'pushed_at')">Last Commit</th>
              <th>Link</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Cut Section -->
    <div class="section blue" id="section-cut">
      <div class="section-header">
        <svg class="pixel-face" viewBox="0 0 16 16">
          <rect width="16" height="16" class="face-fill-blue"/>
          <rect x="4" y="5" width="2" height="2" class="face-feature"/>
          <rect x="10" y="5" width="2" height="2" class="face-feature"/>
          <rect x="5" y="10" width="6" height="1" class="face-feature"/>
        </svg>
        <div class="section-title">
          <h2>Done</h2>
          <div class="section-subtitle">Shipped and complete</div>
        </div>
        <span class="section-count" id="cut-badge">0</span>
      </div>
      <div class="section-content">
        <table id="table-cut">
          <thead>
            <tr>
              <th>Project</th>
              <th>Description</th>
              <th class="sortable" onclick="sortTable('cut', 'pushed_at')">Last Commit</th>
              <th>Link</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Kill Section (collapsed by default) -->
    <div class="section red collapsed" id="section-kill">
      <div class="section-header">
        <svg class="pixel-face" viewBox="0 0 16 16">
          <rect width="16" height="16" class="face-fill-red"/>
          <rect x="4" y="5" width="2" height="2" class="face-feature"/>
          <rect x="10" y="5" width="2" height="2" class="face-feature"/>
          <rect x="5" y="11" width="6" height="1" class="face-feature"/>
          <rect x="4" y="10" width="2" height="1" class="face-feature"/>
          <rect x="10" y="10" width="2" height="1" class="face-feature"/>
        </svg>
        <div class="section-title">
          <h2>Paused</h2>
          <div class="section-subtitle">On hold for now</div>
        </div>
        <span class="section-count" id="kill-badge">0</span>
      </div>
      <button class="section-toggle" onclick="toggleSection('section-kill')">
        Show <span id="kill-toggle-count">0</span> paused projects ↓
      </button>
      <div class="section-content">
        <table id="table-kill">
          <thead>
            <tr>
              <th>Project</th>
              <th>Description</th>
              <th class="sortable" onclick="sortTable('kill', 'pushed_at')">Last Commit</th>
              <th>Link</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // Theme management
    function getStoredTheme() {
      return localStorage.getItem('theme') || 'light';
    }
    
    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);
      updateThemeButton(theme);
      updatePixelFaces(theme);
    }
    
    function updateThemeButton(theme) {
      const btn = document.querySelector('.theme-toggle');
      const label = btn.querySelector('.theme-label');
      const svg = btn.querySelector('svg');
      
      if (theme === 'dark') {
        label.textContent = 'Dark';
        svg.innerHTML = '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>';
      } else {
        label.textContent = 'Light';
        svg.innerHTML = '<circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>';
      }
    }
    
    function updatePixelFaces(theme) {
      const isDark = theme === 'dark';
      const featureColor = isDark ? '#1A1A1A' : '#1A1A1A';
      
      // Update face colors based on theme
      document.querySelectorAll('.face-fill-green').forEach(el => {
        el.setAttribute('fill', isDark ? '#5BA97A' : '#5BA97A');
      });
      document.querySelectorAll('.face-fill-blue').forEach(el => {
        el.setAttribute('fill', isDark ? '#6B8FB6' : '#6B8FB6');
      });
      document.querySelectorAll('.face-fill-red').forEach(el => {
        el.setAttribute('fill', isDark ? '#C47A7A' : '#C47A7A');
      });
      document.querySelectorAll('.face-feature').forEach(el => {
        el.setAttribute('fill', featureColor);
      });
    }
    
    function toggleTheme() {
      const current = getStoredTheme();
      setTheme(current === 'dark' ? 'light' : 'dark');
    }
    
    // Initialize theme
    setTheme(getStoredTheme());

    // Relative time formatter
    function timeAgo(timestamp) {
      if (!timestamp) return '—';
      const seconds = Math.floor((Date.now() - timestamp) / 1000);
      const intervals = [
        { label: 'y', seconds: 31536000 },
        { label: 'mo', seconds: 2592000 },
        { label: 'w', seconds: 604800 },
        { label: 'd', seconds: 86400 },
        { label: 'h', seconds: 3600 },
        { label: 'm', seconds: 60 },
      ];
      for (const { label, seconds: s } of intervals) {
        const count = Math.floor(seconds / s);
        if (count >= 1) return `${count}${label} ago`;
      }
      return 'just now';
    }

    // Store loaded data for sorting
    let portfolioData = null;

    // Sort state per table
    const sortState = { ship: null, cut: null, kill: null };

    function sortTable(category, field) {
      if (!portfolioData) return;
      const categoryMap = { ship: 'active', cut: 'done', kill: 'paused' };
      const list = portfolioData.projects.filter(p => p.category === categoryMap[category]);

      // Toggle sort direction
      if (sortState[category] === 'desc') {
        sortState[category] = 'asc';
        list.sort((a, b) => (a[field] || 0) - (b[field] || 0));
      } else {
        sortState[category] = 'desc';
        list.sort((a, b) => (b[field] || 0) - (a[field] || 0));
      }

      // Update header classes
      document.querySelectorAll(`#table-${category} th.sortable`).forEach(th => {
        th.classList.remove('asc', 'desc');
        if (sortState[category]) th.classList.add(sortState[category]);
      });

      // Re-render just this table
      fillTable(`table-${category}`, list);
    }

    // Section toggle
    function toggleSection(id) {
      document.getElementById(id).classList.toggle('collapsed');
    }

    // Fill a table with projects
    function fillTable(id, list) {
      const tbody = document.querySelector(`#${id} tbody`);
      tbody.innerHTML = '';
      const sevenDaysAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
      const thirtyDaysAgo = Date.now() - (30 * 24 * 60 * 60 * 1000);

      list.forEach(p => {
        const tr = document.createElement('tr');
        const starsHtml = p.stars ? `<span class="project-stars">★${p.stars}</span>` : '';

        // Color code: green if <7d, muted if >30d
        let commitClass = 'last-commit';
        if (p.pushed_at && p.pushed_at > sevenDaysAgo) commitClass += ' recent';
        else if (!p.pushed_at || p.pushed_at < thirtyDaysAgo) commitClass += ' stale';

        tr.innerHTML = `
          <td>
            <a href="${p.repoUrl}" target="_blank" class="project-name">${p.displayName}</a>${starsHtml}
            <div class="verdict">${p.notes}</div>
          </td>
          <td class="desc">${p.description}</td>
          <td class="${commitClass}">${timeAgo(p.pushed_at)}</td>
          <td>${p.liveUrl ? `<a href="${p.liveUrl}" target="_blank" class="btn-live">Live →</a>` : '<span class="no-link">—</span>'}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Render projects from API data
    function render(data) {
      portfolioData = data; // Store for sorting
      const active = data.projects.filter(p => p.category === 'active');
      const done = data.projects.filter(p => p.category === 'done');
      const paused = data.projects.filter(p => p.category === 'paused');

      document.getElementById('ship-count').textContent = active.length;
      document.getElementById('cut-count').textContent = done.length;
      document.getElementById('kill-count').textContent = paused.length;
      document.getElementById('ship-badge').textContent = active.length;
      document.getElementById('cut-badge').textContent = done.length;
      document.getElementById('kill-badge').textContent = paused.length;
      document.getElementById('kill-toggle-count').textContent = paused.length;

      fillTable('table-ship', active);
      fillTable('table-cut', done);
      fillTable('table-kill', paused);

      // Show last updated time
      const updatedAt = new Date(data.generatedAt);
      document.querySelector('.stats').innerHTML = `
        <strong>Summary:</strong>
        <span id="ship-count">${active.length}</span> active,
        <span id="cut-count">${done.length}</span> done,
        <span id="kill-count">${paused.length}</span> paused
        <span style="color: var(--text-faint); margin-left: var(--space-2);">· Updated ${updatedAt.toLocaleDateString()}</span>
      `;
    }

    // Show loading state
    function showLoading() {
      ['table-ship', 'table-cut', 'table-kill'].forEach(id => {
        const tbody = document.querySelector(`#${id} tbody`);
        tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--text-muted);">Loading...</td></tr>';
      });
    }

    // Show error state
    function showError(message) {
      ['table-ship', 'table-cut', 'table-kill'].forEach(id => {
        const tbody = document.querySelector(`#${id} tbody`);
        tbody.innerHTML = `<tr><td colspan="4" style="text-align: center; color: var(--red-text);">${message}</td></tr>`;
      });
    }

    // Fetch and render
    async function init() {
      showLoading();
      try {
        const response = await fetch('/api/portfolio');
        if (!response.ok) throw new Error('Failed to load');
        const data = await response.json();
        if (data.error) throw new Error(data.error);
        render(data);
      } catch (err) {
        showError('Failed to load projects');
        console.error(err);
      }
    }

    init();
  </script>
</body>
</html>
